<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>입출고등록</title>
    <link rel="stylesheet" href="/common/css/main.css">
    <link rel="stylesheet" href="/common/css/header.css">
    <link rel="stylesheet" href="/common/css/footer.css">
    <link rel="stylesheet" href="/common/css/inventory.css">
    <script src="/common/js/static/include.js"></script>

    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>

</head>

<body>
<div data-include-html="/admin/header_admin" class="include"></div>

<section>
    <!-- 왼쪽 메뉴 베너 -->
    <div class="section-nav">
        <div class="section-nav-category">
            <a href="/inventory/admin_inventory">재고관리</a>
        </div>
        <div class="section-nav-category">
            <a href="/inventory/admin_inventory_register"><b>입출고등록</b></a>
        </div>
        <div class="section-nav-category">
            <a href="/inventory/admin_inventory_search">입출고내역</a>
        </div>
    </div>


        <!-- 컨텐츠 영역 시작 -->
        <div class="section-content">
            <div class="section-title">입출고등록</div>
            <div class="section-regSearch">

                <!-- 2-1. 입출고등록 대상 상품 검색 -->
                <div class="section-regSearch-line1">
                    <form action="/inventory/admin_inventory_register">
                        <div>
                            <span class="section-regSearch-span">상품코드
                                <input type="text" name="productCode" id="productCode" class="section-regSearch-input" placeholder="상품코드입력">
                            </span>
                            <span class="section-regSearch-span">상품명
                                <input type="text" name="productName" id="productName" class="section-regSearch-input" placeholder="상품명입력">
                            </span>
                            <span class="section-regSearch-span">카테고리
                                <select name="categoryCode" id="categoryCode" class="section-regSearch-input option1">
                                    <option value="">선택</option>
                                    <option value="3">TV</option>
                                    <option value="4">에어컨</option>
                                    <option value="5">냉장고</option>
                                    <option value="6">전자레인지</option>
                                    <option value="7">커피포트</option>
                                    <option value="8">에어프라이</option>
                                    <option value="9">인덕션</option>
                                </select>
                            </span>
                            <button id="sendInvenSearch" class="btn_basic" type="button">검색</button>
                        </div>
                    </form>
                </div>

                <!-- 2-2. 검색 결과 리스트 대상 상품 등록 -->
                <form id="inventory-form">
                    <div class="section-regSearch-line2">
                        <div>
                            <span class="section-regSearch-span">등록구분
                                <select id="inventypeOption" class="section-regSearch-input option2">
                                    <option value="">선택</option>
                                    <option name="invenIn" value="입고">입고</option>
                                    <option name="invenOut" value="출고">출고</option>
                                </select>
                            </span>
                            <span id="invenRegOption2" class="section-regSearch-span">입고일자
                            <input type="date" name="stockDate" id="stockDate" class="section-regSearch-input date">
                        </span>
                            <span class="section-regSearch-span">비고
                            <input type="text" name="stockComment" id="stockComment" class="section-regSearch-input option" placeholder="비고입력">
                        </span>
                            <span class="section-regSearch-span">수량
                            <input class="section-regSearch-input amount" type="number" name="stockAmount" id="stockAmount" min="0" max="1000" step="1" value="0">
                        </span>
                        </div>
                        <div>
                            <input class="btn_basic" type="reset" value="다시입력" onclick="resetTable()">
                            <input class="btn_basic" id="allOption" type="button" value="일괄반영">
                        </div>
                    </div>
                </form>
            </div>

            <!-- 입출고등록용 검색 테이블 -->

            <table id="searchResultTable" class="section-regSearchResult-table">
                <thead>
                    <tr>
                        <th class="column1"><input type="checkbox"></th>
                        <th>상품코드</th>
                        <th>상품명</th>
                        <th>카테고리</th>
                        <th>현재재고</th>
                        <th>등록구분</th>
                        <th>입고일자</th>
                        <th>비고</th>
                        <th class="column8">등록수량</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>

            <div class="section-regSearch">
                <div class="section-regSearch-btn">
                    <input class="btn_basic2" type="submit" value="등록">
                </div>


              <!-- 페이징 -->
                <div class="paging1">
                    <span>&lt;</span>
                    <span style="color: #4D4D4D;">1</span>
                    <span>2</span>
                    <span>3</span>
                    <span>4</span>
                    <span>5</span>
                    <span>&gt;</span>
                </div>
            </div>
        </div>
    </section>

    <!-- footer -->
    <div data-include-html="/admin/footer" class="include"></div>


    <!-- 스크립트 시작-->
    <script th:inline="javascript">

        // 검색 버튼
        $("#sendInvenSearch").click(function (){

            let productCode = $("#productCode").val().toUpperCase();
            let productName = $("#productName").val().toUpperCase();
            let categoryCode = $("#categoryCode").val();
            let productAmount = $("#productAmount").val();

            let data = {
                productCode : productCode,
                productName : productName,
                categoryCode : categoryCode,
                productAmount : productAmount
            };

            $.ajax({
                url: "/inventory/admin_inventory_register",
                data : data,
                type : 'post',
                success: function (data){

                    $("#searchResultTable tbody").empty();

                    $.each(data, function (index, stock) {
                        let row = $("<tr></tr>");
                        row.append("<td><input type='checkbox'></td>");
                        row.append("<td>" + stock.productCode + "</td>");
                        row.append("<td>" + stock.productName + "</td>");
                        row.append("<td>" + stock.category.categoryName + "</td>");
                        row.append("<td>" + stock.productAmount + "</td>");
                        row.append("<td></td>");
                        row.append("<td></td>");
                        row.append("<td></td>");
                        row.append("<td></td>");
                        $("#searchResultTable tbody").append(row);
                    });
                },
                error: function (error) {
                    alert(error);
                }
            });
        });

        // 일괄반영 버튼
        $("#allOption").click(function (){


            let stockType = $("#inventypeOption option:selected").val();
            let stockDate = $("#stockDate").val();
            let stockComment = $("#stockComment").val();
            let stockAmount = $("#stockAmount").val();

            if(stockAmount <= 0){
                alert("수량 확인 필요");
                return false
            }


            $("#searchResultTable tbody tr").each(function() {
                let row = $(this);

                row.find("td:eq(5)").text(stockType);
                row.find("td:eq(6)").text(stockDate);
                row.find("td:eq(7)").text(stockComment);
                row.find("td:eq(8)").text(stockAmount);
            });
        });

        // 다시입력 버튼
        $(document).ready(function() {

            $('input[type="reset"]').on('click', function (event) {
                event.preventDefault();
                resetTable();
            });

            function resetTable() {
                $('#inventypeOption').val('');
                $('#stockDate').val('');
                $('#stockComment').val('');
                $('#stockAmount').val('0');

                $('.section-regSearchResult-table input[type="checkbox"]').prop('checked', false);
                $('.section-regSearchResult-table tbody tr td:nth-child(6)').text('');
                $('.section-regSearchResult-table tbody tr td:nth-child(7)').text('');
                $('.section-regSearchResult-table tbody tr td:nth-child(8)').text('');
                $('.section-regSearchResult-table tbody tr td:nth-child(9)').text('');

            }

        // 등록버튼
            $('.btn_basic2').on('click', function(event) {
                event.preventDefault();

                let tableRows = $('.section-regSearchResult-table tbody tr');
                let rowData = [];
                let isCheckedExists = false;

                tableRows.each(function() {
                    let row = $(this);
                    let isChecked = row.find('input[type="checkbox"]').prop('checked');

                    if (isChecked) {
                        isCheckedExists = true;

                        let cells = row.find('td');
                        let productCode = cells.eq(1).text();
                        let productAmount = cells.eq(4).text();
                        let stockType = cells.eq(5).text();
                        let stockDate = cells.eq(6).text();
                        let stockComment = cells.eq(7).text();
                        let stockAmount = cells.eq(8).text();

                        if (stockType === '입고') {
                            stockAmount = parseInt(stockAmount);
                        } else if (stockType === '출고') {
                            stockAmount = -parseInt(stockAmount);
                        }

                        if (productCode.trim() === '' || stockType.trim() === '' || stockDate.trim() === '') {
                            alert('입력값을 확인하세요');
                            return false;
                        }

                        rowData.push({
                            productCode: productCode,
                            productAmount: productAmount,
                            stockType: stockType,
                            stockDate: stockDate,
                            stockComment: stockComment,
                            stockAmount: stockAmount
                        });
                    }
                });

                if (!isCheckedExists) {
                    alert("선택 항목 없음");
                    return;
                }

                // let resultMessage = Response.resultMaessage;

                if (rowData.length > 0) {
                    $.ajax({
                        url: '/inventory/stockRegist',
                        type: 'POST',
                        data: JSON.stringify(rowData),
                        contentType: 'application/json',


                        success: function(response) {
                            console.log('Response:', response);
                            let resultMessage = response.resultMessage;
                            console.log('resultMessage:', resultMessage);
                            if (resultMessage === "success") {
                                alert("등록 성공");
                            } else if (resultMessage === "fail") {
                                alert("출고 등록 실패-수량 부족");
                            } else {
                                alert("등록 실패");
                            }
                            location.reload();
                        },
                        error: function(error) {
                            console.log('Error:', error);
                            alert("등록 실패");
                        }
                    });
                }
            });
        });

        // 날짜 기본값 반영
        let today = new Date();
        let stockDateString = today.toISOString().split('T')[0];
        $("#stockDate").val(stockDateString);

      // 입고 일자 오늘로
        $(document).ready(function() {
            let currentDate = new Date().toISOString().split('T')[0];
            $('#invenRegInDate').val(currentDate);
        });

      // 체크박스
        $(document).ready(function() {
            $('.section-regSearchResult-table th input[type="checkbox"]').on('click', function() {
                let isChecked = $(this).prop('checked');

                $('.section-regSearchResult-table td input[type="checkbox"]').prop('checked', isChecked);
            });
        });

    </script>
</body>
</html>