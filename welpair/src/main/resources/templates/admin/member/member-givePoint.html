<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>복지포인트지급</title>
    <script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
    <link rel="stylesheet" href="/common/css/main.css">
    <link rel="stylesheet" href="/common/css/header.css">
    <link rel="stylesheet" href="/common/css/footer.css">
    <link rel="stylesheet" href="/common/css/member.css">
    <script src="/common/js/static/include.js"></script>
</head>

<body>
    <!-- header -->
    <div data-include-html="/admin/header_admin" class="include"></div>

    <div class="container long">

        <div class="navs long">

            <div class="nav-menu"><a href="member-view">회원조회</a></div>
            <div class="nav-menu"><a href="regist">회원등록</a></div>
            <div class="nav-menu"><a href="reqList">가입승인</a></div>
            <div class="nav-menu"><b>복지포인트지급</b></div>
            <div class="nav-menu"><a href="pointHistorySummary">복지포인트지급이력</a></div>
        </div>

        <div class="box">
            <div class="section-title long">복지포인트 지급</div>

            <div class="contents">

                    <div class="search-list top">
                        <input type="text" class="search-input">
                        <button class="button-circle">검색</button>
                    </div>

                    

                <!-- 제목행의 6,7,8 열에 필터 적용하기 -->
                <table id="table-givepoint">
                    <thead>
                        <tr>
                            <th class="checkbox-cell"><input type="checkbox" id="select-all3" onclick="allChecked()"></th>
                            <th>아이디</th>
                            <th>이름</th>
                            <th>이메일</th>
                            <th>연락처</th>
                            <th>부서
                                <select id="filter-dept">
                                    <option value="all">All</option>
                                    <option value="dept1">영업</option>
                                    <option value="dept2">구매</option>
                                    <option value="dept2">인사</option>
                                    <option value="dept2">재무</option>
                                    <option value="dept2">품질</option>
                                    <option value="dept2">생산</option>
                                    <option value="dept2">고객</option>
                                    <option value="dept2">개발</option>
                                    <option value="dept2">법무</option>
                                </select>
                            </th>
                            <th>직급</th>
                            <th>근속연수</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="member:${memberList}" class="member-row">
                            <td class="checkbox-cell"><input type="checkbox" name="chk" class="chk" onclick="chkClicked()" th:value="${member.empNo}"></td>
                            <td th:text="${member.empNo}"></td>
                            <td th:text="${member.employee.empName}"></td>
                            <td th:text="${member.employee.empEmail}"></td>
                            <td th:text="${member.employee.empPhone}"></td>
                            <td th:text="${member.employee.deptDTO.deptName}"></td>
                            <td th:text="${member.employee.jobDTO.jobName}"></td>
                            <td th:text="${member.employee.yearCount}"></td>
                        </tr>
                    </tbody>
                </table>

                <div class="under-table">
                    <div class="paging">
                        <span>&lt;</span>
                        <span>1</span>
                        <span>2</span>
                        <span>3</span>
                        <span>4</span>
                        <span>5</span>
                        <span>&gt;</span>
                    </div>
                </div>
                <form action="" method="post" id="form-point">
                    <div class="form-group2">
                        <span>
                            <label>선택 회원 수</label>
                        </span>
                        <span class="count">
                            <span id="selectedCount" th:text="${selectedElementsCnt ?: 0 }">0</span><label> 명</label>
                        </span>
                    </div>

                    <div class="form-group2">
                        <label for="reason">지급 사유</label>
                        <select name="pointreason" id="reason">
                            <option value="general">정기지급</option>
                            <option value="special">특별지급</option>
                        </select>
                    </div>

                    <div class="form-group2">
                        <label for="amount-input">회원당 지급액</label>
                        <input type="number" id=amount-input step="1000000" min="0" max="9000000">
                        <span id="amount-summary"></span>
                    </div>

                    <div class="form-group2">
                        <span>
                            <label>지급액 합계</label>
                        </span>
                        <span class="count">
                            <span>10,000,000</span><label>원</label>
                        </span>
                        <button class="button-square3 point">지급하기</button>
                    </div>
                </form>

            </div> <!--컨텐츠-->

        </div> <!--박스-->

    </div> <!--컨테이너-->


    <!-- footer -->
    <div data-include-html="/admin/footer" class="include"></div>


    <script>

        function allChecked(target) {
            //전체 체크박스
            const checkbox = document.getElementById('select-all3');
            //전체 체크박스 체크여부
            const is_checked = checkbox.checked;

            //전체 체크박스 체크여부 true면 일반 체크박스 전부 체크되게
            if (is_checked) {
                chkAllChecked();

                //체크된 체크박스의 수
                const selectedElements = document.querySelectorAll('input.chk:checked');
                const selectedElementsCnt = selectedElements.length;
                //체크된 체크박스의 수를 표시하는 요소의 text를 위의 '체크된 체크박스 수'값으로 업데이트
                document.getElementById('selectedCount').textContent = selectedElementsCnt;

            } else {
                //전체 해제되게
                chkAllUnChecked();

                //체크된 체크박스의 수
                const selectedElements = document.querySelectorAll('input.chk:checked');
                const selectedElementsCnt = selectedElements.length;
                //체크된 체크박스의 수를 표시하는 요소의 text를 위의 '체크된 체크박스 수'값으로 업데이트
                document.getElementById('selectedCount').textContent = selectedElementsCnt;

            }
        }

        //전체 체크
        function chkAllChecked() {
            document.querySelectorAll(".chk").forEach(function(v,i){
                v.checked = true;
            });
        }

        //전체 해제
        function chkAllUnChecked() {
            document.querySelectorAll(".chk").forEach(function (v,i) {
                v.checked = false;
            });
        }

        //개별 체크박스
        function chkClicked() {
            //체크박스 수
            const allCount = document.querySelectorAll(".chk").length;
            //체크된 체크박스의 수 구하기
            const query = 'input[name="chk"]:checked';
            const selectedElements = document.querySelectorAll(query);
            const selectedElementsCnt = selectedElements.length;
            console.log('체크된 체크박스의 수 : ' + selectedElementsCnt);
            //두 수가 같으면 전체 체크박스 체크되게함
            if(allCount == selectedElementsCnt) {
                document.getElementById('select-all3').checked = true;
            }
            //다르면 전체 체크박스 해제
            else {
                document.getElementById('select-all3').checked = false;
            }

            //***체크된 체크박스의 수를 표시하는 요소의 text를 위의 '체크된 체크박스 수'값으로 업데이트
            document.getElementById('selectedCount').textContent = selectedElementsCnt;
        }



        //부서 필터 적용하기
        document.getElementById('filter-dept').addEventListener('change', function() {
           filterTableByDept(this.value);
        });

        function filterTableByDept(selectedDept) {
            //tbody에서 모든 행 가져오기
            // let rows = document.getElementById('table-givepoint').getElementsByTagName('tbody')[0].rows;
            let rows = document.getElementsByClassName('member-row');

            for(let i=0; i<rows.length; i++) {
                let row = rows[i];

                //현재 행의 부서 열 값
                let dept = row.cells[5].textContent.trim();

                //선택된 부서에 따라 행을 보이고 숨기기
                if(selectedDept === 'All' || dept === selectedDept) {
                    row.style.display = ''; //행을 보이게함
                } else {
                    row.style.display = 'none';
                }
            }
        }










        //지급하기 버튼을 눌렀을때 사용될 비동기처리 함수를 작성하기
        // function currentSelectedCount() {
        //
        //     $.ajax({
        //        url: '/getSelectedCount', //URL 매핑
        //        type: 'GET',
        //        success: function(count) {
        //            $('#selectedCount').text(count);
        //        }
        //     });
        // }








        //@회원당지급액 입력시 요약하여 보여주기
        const amountInput = document.getElementById('amount-input');
        const amountSummary = document.getElementById('amount-summary');

        amountInput.addEventListener('input', updateAmountSummary);

        function updateAmountSummary() {
            const amount = amountInput.value;
            const summary = formatAmountSummary(amount);
            amountSummary.textContent = summary;
        }

        function formatAmountSummary(amount) {
            const baekman = 1000000;
            const cheonman = 10000000;

            if (amount >= baekman) {
                const summary1 = (amount / baekman);
                return `${summary1} 백만원`;
            }

            if (amount >= cheonman) {
                const summary2 = (amount / cheonman);
                return `${summary2} 천만원`;
            }
            return `${amount}원`;
        }



        // @테이블 제목행의 6,7,8열에 필터 적용시키기 (일단 6번째 열만) (모든 행이 숨겨지는 문제 발생, 테이블 위치 문제도 해결해야)
        // const filter = document.getElementById("filter-dept")
        // filter.addEventListener('change', function() {
        //     const filterValue = this.value; //<select>에서 선택된 값을 filterValue에 저장
        //     const rows = document.querySelectorAll('#table-givepoint tbody tr'); //필터링대상 행들을 변수에 저장
        //
        //     rows.forEach(row => {
        //         const columnValue = row.querySelector('td:nth-child(6)').textContent;
        //         if(columnValue === filterValue || filterValue === 'all') {
        //             row.style.display = ''; //기본 css설정대로 행이 표시된다
        //         } else {
        //             row.style.display = 'none'; //해당 행이 보여지지 않는다
        //         }
        //     });
        // });
    
    </script>
</body>


</html>