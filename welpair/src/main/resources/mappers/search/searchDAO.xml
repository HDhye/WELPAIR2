<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hielectro.welpair.search.model.dao.SearchDAO">


    <resultMap id="prodSearchResultMap" type="com.hielectro.welpair.search.model.dto.SearchDTO">
        <result property="sellPrice" column="SELLPRICE"></result>
        <association property="sellPage" resultMap="getSellPageResultMap"></association>
        <association property="thumbnailImage" resultMap="getThumbnailImageResultMap"></association>
        <association property="sellItemPage" resultMap="getSellItemPageResultMap"></association>
        <association property="sellProduct" resultMap="getSellProductResultMap"></association>
        <association property="product" resultMap="getProductResultMap"></association>
        <association property="category" resultMap="getCategoryResultMap"></association>
    </resultMap>

    <resultMap id="getSellPageResultMap" type="com.hielectro.welpair.sellproduct.model.dto.SellPageDTO">
        <result property="no" column="SELL_PAGE_NO"></result>
        <result property="title" column="SELL_PAGE_TITLE"></result>
    </resultMap>
    <resultMap id="getThumbnailImageResultMap" type="com.hielectro.welpair.sellproduct.model.dto.ThumbnailImageDTO">
        <result property="no" column="SELL_PAGE_NO"></result>
    </resultMap>
    <resultMap id="getSellItemPageResultMap" type="com.hielectro.welpair.sellproduct.model.dto.SellItemPageDTO">
        <result property="no" column="SELL_PAGE_NO"></result>
        <result property="id" column="SELL_PRODUCT_ID"></result>
    </resultMap>
    <resultMap id="getSellProductResultMap" type="com.hielectro.welpair.sellproduct.model.dto.SellProductDTO">
        <result property="id" column="SELL_PRODUCT_ID"></result>
        <result property="discount" column="DISCOUNT"></result>
        <result property="isSell" column="IS_SELL"></result>
        <result property="productCode" column="PRODUCT_CODE"></result>
    </resultMap>
    <resultMap id="getProductResultMap" type="com.hielectro.welpair.inventory.model.dto.ProductDTO">
        <result property="productCode" column="PRODUCT_CODE"></result>
        <result property="productPrice" column="PRODUCT_PRICE"></result>
        <result property="categoryCode" column="CATEGORY_CODE"></result>
    </resultMap>
    <resultMap id="getCategoryResultMap" type="com.hielectro.welpair.inventory.model.dto.ProductDTO">
        <result property="categoryCode" column="CATEGORY_CODE"></result>
        <result property="refCategoryCode" column="REF_CATEGORY_CODE"></result>
    </resultMap>

    <select id="searchResultMain" resultMap="prodSearchResultMap">
        SELECT
               A.SELL_PAGE_TITLE /* AS 판매상품명*/
             , E.PRODUCT_PRICE * (1 - D.DISCOUNT) AS SELLPRICE /*AS 판매가격*/
             , B.SELL_THUMB_IMAGE_FILE_NAME /*AS 썸네일이미지*/
             , A.SELL_PAGE_NO /*AS 판매페이지주소*/
          FROM T_SELL_PAGE A
          JOIN T_THUMB_IMAGE B ON B.SELL_PAGE_NO = A.SELL_PAGE_NO
          JOIN T_SELL_ITEM_PAGE C ON C.SELL_PAGE_NO = A.SELL_PAGE_NO
          JOIN T_SELL_PRODUCT D ON D.SELL_PRODUCT_ID = C.SELL_PRODUCT_ID
          JOIN T_PRODUCT E ON E.PRODUCT_CODE = D.PRODUCT_CODE
          JOIN T_CATEGORY F ON F.CATEGORY_CODE = E.CATEGORY_CODE
         WHERE D.IS_SELL = 'Y'
            <if test="sellPage.title != null and sellPage.title != ''">
                AND A.SELL_PAGE_TITLE LIKE '%' || #{sellPage.title} || '%'
            </if>
            <if test="product.categoryCode != null and product.categoryCode != ''">
                AND E.CATEGORY_CODE = #{product.categoryCode}
            </if>
            <if test="category.refCategoryCode != null and category.refCategoryCode != ''">
                AND F.REF_CATEGORY_CODE = #{category.refCategoryCode}
            </if>
    </select>
    <select id="searchDetailResult" resultMap="prodSearchResultMap">
        SELECT
        A.SELL_PAGE_TITLE /* AS 판매상품명*/
        , E.PRODUCT_PRICE * (1 - D.DISCOUNT) AS SELLPRICE /*AS 판매가격*/
        , B.SELL_THUMB_IMAGE_FILE_NAME /*AS 썸네일이미지*/
        , A.SELL_PAGE_NO /*AS 판매페이지주소*/
        FROM T_SELL_PAGE A
        JOIN T_THUMB_IMAGE B ON B.SELL_PAGE_NO = A.SELL_PAGE_NO
        JOIN T_SELL_ITEM_PAGE C ON C.SELL_PAGE_NO = A.SELL_PAGE_NO
        JOIN T_SELL_PRODUCT D ON D.SELL_PRODUCT_ID = C.SELL_PRODUCT_ID
        JOIN T_PRODUCT E ON E.PRODUCT_CODE = D.PRODUCT_CODE
        WHERE D.IS_SELL = 'Y'
        <if test="sellPage.title != null and sellPage.title != ''">
            AND A.SELL_PAGE_TITLE LIKE '%' || #{sellPage.title} || '%'
        </if>
        <if test="product.categoryCode != null and product.categoryCode != ''">
            AND E.CATEGORY_CODE = #{product.categoryCode}
        </if>
        <if test="minPrice != null and minPrice != ''">
            AND E.PRODUCT_PRICE * (1 - D.DISCOUNT) >= #{minPrice}
        </if>
        <if test="maxPrice != null and maxPrice != ''">
            AND E.PRODUCT_PRICE * (1 - D.DISCOUNT) &lt;= #{maxPrice}
        </if>
    </select>
</mapper>
