<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.hielectro.welpair.sellproduct.model.dao.SellProductMapper">
    <resultMap id="SellProductResultMap" type="com.hielectro.welpair.sellproduct.model.dto.SellProductDTO">
        <id property="id" column="SELL_PRODUCT_ID"/>
        <result property="code" column="PRODUCT_CODE"/>
        <result property="discount" column="DISCOUNT"/>
        <result property="isSell" column="IS_SELL"/>

        <association property="product" resultMap="ProductDTO"/>
        <collection property="sellItemPageList" resultMap="SellItemPageDTO"/>
    </resultMap>

    <resultMap id="ProductDTO" type="com.hielectro.welpair.inventory.model.dto.ProductDTO">
        <id property="productCode" column="PRODUCT_CODE"/>
        <result property="productName" column="PRODUCT_NAME"/>
        <result property="productStatus" column="PRODUCT_STATUS"/>
        <result property="productPrice" column="PRODUCT_PRICE"/>
        <result property="productOption" column="PRODUCT_OPTION"/>
    </resultMap>

    <resultMap id="SellItemPageDTO" type="com.hielectro.welpair.sellproduct.model.dto.SellItemPageDTO">
        <id property="no" column="SELL_PAGE_NO"/>
        <id property="id" column="SELL_PRODUCT_ID"/>

        <association property="sellPage" resultMap="SellPageDTO"/>
    </resultMap>

    <resultMap id="SellPageDTO" type="com.hielectro.welpair.sellproduct.model.dto.SellPageDTO">
        <id property="no" column="SELL_PAGE_NO"/>
        <result property="title" column="SELL_PAGE_TITLE"/>
    </resultMap>

    <resultMap id="SellProductDetailDTO" type="com.hielectro.welpair.sellproduct.model.dto.SellProductDetailDTO">
        <id property="id" column="SELL_PRODUCT_ID"/>
        <result property="name" column="PRODUCT_NAME"/>
        <result property="status" column="PRODUCT_STATUS"/>
        <result property="price" column="PRODUCT_PRICE"/>
        <result property="discount" column="DISCOUNT"/>
        <result property="option" column="PRODUCT_OPTION"/>
        <result property="pageNo" column="SELL_PAGE_NO"/>
        <result property="title" column="SELL_PAGE_TITLE"/>
    </resultMap>

    <resultMap id="ReviewManagerDTO" type="com.hielectro.welpair.board.model.dto.ReviewManagerDTO">
        <id property="no" column="BOARD_NO"/>
        <result property="pageNo" column="SELL_PAGE_NO"/>
        <result property="name" column="PRODUCT_NAME"/>
        <result property="title" column="BOARD_TITLE"/>
        <result property="content" column="BOARD_CONTENT"/>
        <result property="date" column="BOARD_DATE"/>
        <result property="time" column="BOARD_TIME"/>
    </resultMap>

    <resultMap id="QnAManagerDTO" type="com.hielectro.welpair.board.model.dto.QnAManagerDTO">
        <id property="no" column="BOARD_NO"/>
        <result property="pageNo" column="SELL_PAGE_NO"/>
        <result property="title" column="BOARD_TITLE"/>
        <result property="content" column="BOARD_CONTENT"/>
        <result property="date" column="BOARD_DATE"/>
        <result property="time" column="BOARD_TIME"/>
    </resultMap>
    <select id="sellProductSearchCount" resultType="_int">
        SELECT
        COUNT(*)
        FROM (
        SELECT ROWNUM AS RN
        , SELL_PRODUCT_ID
        , PRODUCT_NAME
        , DISCOUNT
        , IS_SELL
        , SELL_PAGE_NO
        , SELL_PAGE_TITLE
        FROM T_SELL_PRODUCT
        LEFT JOIN T_PRODUCT USING (PRODUCT_CODE)
        LEFT JOIN T_SELL_ITEM_PAGE USING (SELL_PRODUCT_ID)
        LEFT JOIN T_SELL_PAGE USING (SELL_PAGE_NO)
        )
        WHERE 1=1
        <if test="code != '' and code != null">
            AND SELL_PRODUCT_ID = #{ code }
        </if>
        <if test="name != '' and name != null">
            AND PRODUCT_NAME LIKE '%' || #{ name } || '%'
        </if>
    </select>

    <select id='selectProductList' resultMap="SellProductDetailDTO">
        SELECT
        *
        FROM (
        SELECT ROWNUM AS RN
        , SELL_PRODUCT_ID
        , PRODUCT_NAME
        , PRODUCT_STATUS
        , PRODUCT_PRICE
        , DISCOUNT
        , PRODUCT_OPTION
        , SELL_PAGE_NO
        , SELL_PAGE_TITLE
        FROM T_SELL_PRODUCT
        LEFT JOIN T_PRODUCT USING (PRODUCT_CODE)
        LEFT JOIN T_SELL_ITEM_PAGE USING (SELL_PRODUCT_ID)
        LEFT JOIN T_SELL_PAGE USING (SELL_PAGE_NO)
        WHERE 1=1
        <if test="code != '' and code != null">
            AND SELL_PRODUCT_ID = #{ code }
        </if>
        <if test="name != '' and name != null">
            AND PRODUCT_NAME LIKE '%' || #{ name } || '%'
        </if>
        )
        <if test="pageNo != '0' and pageNo != null">
            WHERE 1=1
            AND RN &gt; ( (TO_NUMBER(#{ pageNo }) - 1) * 10)
            AND RN &lt;= ( TO_NUMBER(#{ pageNo }) * 10)
        </if>
    </select>

    <select id="reviewSearchCount" resultType="_int">
        SELECT
        COUNT(*)
        FROM (
        SELECT ROWNUM AS RN
        , TB.BOARD_NO
        , TR.SELL_PAGE_NO
        , TP.PRODUCT_NAME
        , TB.BOARD_TITLE
        , TB.BOARD_CONTENT
        , TO_DATE(TB.BOARD_DATE, 'RRRR-MM-DD') as BOARD_DATE
        , TO_CHAR(TB.BOARD_DATE, 'HH24:MI:ss') as BOARD_TIME
        FROM T_BOARD TB
        JOIN T_REVIEW TR on TB.BOARD_NO = TR.BOARD_NO
        JOIN T_ORDER T on (TR.ORDER_NO = T.ORDER_NO AND TB.EMP_NO = T.EMP_NO)
        JOIN T_PRODUCT_ORDER TPO on T.ORDER_NO = TPO.ORDER_NO
        JOIN T_SELL_PRODUCT TSP on TSP.SELL_PRODUCT_ID = TPO.SELL_PRODUCT_ID
        JOIN T_PRODUCT TP on TP.PRODUCT_CODE = TSP.PRODUCT_CODE
        WHERE 1=1
        <if test="search.id != '' and search.id != null">
            AND TSP.SELL_PRODUCT_ID = #{ search.id }
        </if>
        <if test="search.name != '' and search.name != null">
            AND TP.PRODUCT_NAME LIKE '%' || #{ search.name } || '%'
        </if>
        <choose>
            <when test="search.startDate != null and search.endDate != null">
                AND BOARD_DATE >= #{ search.startDate }
                AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
            <when test="search.startDate != null">
                AND BOARD_DATE >= #{ search.startDate }
            </when>
            <when test="search.endDate != null">
                AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
        </choose>
        )
        WHERE 1=1
    </select>

    <select id="selectReviewList" resultMap="ReviewManagerDTO">
        SELECT
                *
        FROM (
        SELECT ROWNUM AS RN
        , TB.BOARD_NO
        , TR.SELL_PAGE_NO
        , TP.PRODUCT_NAME
        , TB.BOARD_TITLE
        , TB.BOARD_CONTENT
        , TO_DATE(TB.BOARD_DATE, 'RRRR-MM-DD') as BOARD_DATE
        , TO_CHAR(TB.BOARD_DATE, 'HH24:MI:ss') as BOARD_TIME
        FROM T_BOARD TB
        JOIN T_REVIEW TR on TB.BOARD_NO = TR.BOARD_NO
        JOIN T_ORDER T on (TR.ORDER_NO = T.ORDER_NO AND TB.EMP_NO = T.EMP_NO)
        JOIN T_PRODUCT_ORDER TPO on T.ORDER_NO = TPO.ORDER_NO
        JOIN T_SELL_PRODUCT TSP on TSP.SELL_PRODUCT_ID = TPO.SELL_PRODUCT_ID
        JOIN T_PRODUCT TP on TP.PRODUCT_CODE = TSP.PRODUCT_CODE
        WHERE 1=1
        <if test="search.id != '' and search.id != null">
            AND TSP.SELL_PRODUCT_ID = #{ search.id }
        </if>
        <if test="search.name != '' and search.name != null">
            AND TP.PRODUCT_NAME LIKE '%' || #{ search.name } || '%'
        </if>
        <choose>
            <when test="search.startDate != null and search.endDate != null">
                AND BOARD_DATE >= #{ search.startDate }
                AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
            <when test="search.startDate != null">
                AND BOARD_DATE >= #{ search.startDate }
            </when>
            <when test="search.endDate != null">
                AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
        </choose>
        )
        WHERE 1=1
        <if test="pageNo != '0' and pageNo != null">
            AND RN &gt; ( (TO_NUMBER(#{ pageNo }) - 1) * 10)
            AND RN &lt;= ( TO_NUMBER(#{ pageNo }) * 10)
        </if>
    </select>

    <select id="qnaSearchCount" resultType="_int">
        SELECT
        COUNT(*)
        FROM (
        SELECT ROWNUM AS RN
        , BOARD_NO
        , SELL_PAGE_NO
        , BOARD_TITLE
        , BOARD_CONTENT
        , TO_DATE(BOARD_DATE, 'RRRR-MM-DD') as BOARD_DATE
        , TO_CHAR(BOARD_DATE, 'HH24:MI:ss') as BOARD_TIME
        FROM T_BOARD
        JOIN T_QNA USING (BOARD_NO)
        JOIN T_SELL_PAGE USING (SELL_PAGE_NO)
        WHERE 1=1
        <if test="search.id != '' and search.id != null">
            AND SELL_PRODUCT_ID = #{ search.id }
        </if>
        <if test="search.name != '' and search.name != null">
            AND PRODUCT_NAME = #{ search.name }
        </if>
        <choose>
            <when test="search.startDate != null and search.endDate != null">
            AND BOARD_DATE >= #{ search.startDate }
            AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
            <when test="search.startDate != null">
            AND BOARD_DATE >= #{ search.startDate }
            </when>
            <when test="search.endDate != null">
            AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
        </choose>
        )
        WHERE BOARD_DATE IS NOT NULL
    </select>

    <select id="selectQnAList" resultMap="QnAManagerDTO">
        SELECT
                *
        FROM (
        SELECT ROWNUM AS RN
        , BOARD_NO
        , SELL_PAGE_NO
        , BOARD_TITLE
        , BOARD_CONTENT
        , TO_DATE(BOARD_DATE, 'RRRR-MM-DD') as BOARD_DATE
        , TO_CHAR(BOARD_DATE, 'HH24:MI:ss') as BOARD_TIME
        FROM T_BOARD
        JOIN T_QNA USING (BOARD_NO)
        JOIN T_SELL_PAGE USING (SELL_PAGE_NO)
        WHERE 1=1
        <if test="search.id != '' and search.id != null">
            AND SELL_PRODUCT_ID = #{ search.id }
        </if>
        <if test="search.name != '' and search.name != null">
            AND PRODUCT_NAME = #{ search.name }
        </if>
        <choose>
            <when test="search.startDate != null and search.endDate != null">
                AND BOARD_DATE >= #{ search.startDate }
                AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
            <when test="search.startDate != null">
                AND BOARD_DATE >= #{ search.startDate }
            </when>
            <when test="search.endDate != null">
                AND BOARD_DATE &lt;= #{ search.endDate }
            </when>
            <otherwise>
            </otherwise>
        </choose>
        )
        WHERE BOARD_DATE IS NOT NULL
        <if test="pageNo != '0' and pageNo != null">
            AND RN &gt; ( (TO_NUMBER(#{ pageNo }) - 1) * 10)
            AND RN &lt;= ( TO_NUMBER(#{ pageNo }) * 10)
        </if>

    </select>

    <delete id="sellProductDelete">
        DELETE
        FROM T_SELL_PRODUCT
        WHERE SELL_PRODUCT_ID = #{ id }
    </delete>
</mapper>